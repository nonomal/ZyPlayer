import { db, client, schema } from '../../common';
import { tblSetting } from './init';
import logger from '@main/core/logger';

const update = async () => {
  await client.exec(`
    CREATE TABLE IF NOT EXISTS tbl_setting (
      id uuid DEFAULT gen_random_uuid(),
      key varchar(255) not null,
      value text DEFAULT null
    );

    CREATE TABLE IF NOT EXISTS tbl_site (
      id uuid DEFAULT gen_random_uuid(),
      name varchar(255) not null,
      key varchar(255) not null,
      api varchar(255) not null,
      "playUrl" varchar(255),
      search integer not null default 0,
      "group" varchar(255),
      type integer not null,
      ext text,
      categories varchar(255),
      "isActive" boolean not null default true
    );

    CREATE TABLE IF NOT EXISTS tbl_iptv (
      id uuid DEFAULT gen_random_uuid(),
      name varchar(255) not null,
      url text not null,
      type varchar(255) not null,
      epg varchar(255),
      logo varchar(255),
      "isActive" boolean not null default true
    );

    CREATE TABLE IF NOT EXISTS tbl_channel (
      id uuid DEFAULT gen_random_uuid(),
      name varchar(255) not null,
      url varchar(1024) not null,
      "group" varchar(255)
    );

    CREATE TABLE IF NOT EXISTS tbl_drive (
      id uuid DEFAULT gen_random_uuid(),
      name varchar(255) not null,
      server varchar(255) not null,
      "startPage" varchar(255),
      search boolean not null default false,
      headers varchar(255),
      params varchar(255),
      "showAll" boolean default false,
      "isActive" boolean not null default true
    );

    CREATE TABLE IF NOT EXISTS tbl_analyze (
      id uuid DEFAULT gen_random_uuid(),
      name varchar(255) not null,
      url varchar(255) not null,
      type integer not null default 0,
      "isActive" boolean not null default true
    );

    CREATE TABLE IF NOT EXISTS tbl_star (
      id uuid DEFAULT gen_random_uuid(),
      "date" integer,
      "relateId" varchar(255) not null,
      "videoId" varchar(510) not null,
      "videoImage" varchar(510),
      "videoName" varchar(510),
      "videoType" varchar(255),
      "videoRemarks" varchar(255)
    );

    CREATE TABLE IF NOT EXISTS tbl_history (
      id uuid DEFAULT gen_random_uuid(),
      "date" integer,
      "type" varchar(255) not null,
      "relateId" varchar(255),
      "siteSource" varchar(255),
      "playEnd" boolean,
      "videoId" varchar(510),
      "videoImage" varchar(510),
      "videoName" varchar(510),
      "videoIndex" varchar(510),
      "watchTime" real,
      "duration" real,
      "skipTimeInEnd" real,
      "skipTimeInStart" real
    );
  `);

  if ((await db.select().from(schema.setting)).length === 0) {
    tblSetting.forEach(async (item) => {
      await db.insert(schema.setting).values({ key: item.key, value: { data: item.value } });
    });
  }

  logger.info('[db][init]completed');
};

export default update;
